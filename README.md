# HydraRoute

**Основная цель** — перенаправление запросов к **отдельным доменам** через VPN. Все, что не указанно в списке будет открываться напрямую.

Скрипт облегчает настройку раздельной маршрутизации трафика к доменам на роутерах **Keenetic**.
- Установка **"одной кнопкой"**.
- Никаких сложных настроек.
- Требуется всего 1 действие: указать VPN.

## Функции и возможности:
- Установка необходимых пакетов.
- Настройка и интеграция IPSet с AdGuard Home для управления маршрутизацией.
- Создание скриптов для динамической маршрутизации и маркировки трафика.
- Обход блокировки ECH Cloudflare.
- Установка DNS, защищенных шифрованием.
- Поддержка IPv4 и IPv6*.
	* для работы ipv6 необходимо наличие рабочего ipv6 на основном подключении и на VPN-соединении.
- Фильтрация рекламы.
	* включены базовые фильтры рекламы, малваре и телеметрии Microsoft.
- Список доменов можно редактировать и расширять, после установки в него уже включены:
  - Youtube
  - Instagram
  - OpenAI (ChatGPT)
  - Некоторые T-трекеры
  
  - GitHub

## Требования:
- KeenOS версия 4.х (Работа на 3.х возможна, но не тестировалась)
- Развёрнутая среда [Entware](https://help.keenetic.com/hc/ru/articles/360021214160-Установка-системы-пакетов-репозитория-Entware-на-USB-накопитель).
- Настроенное VPN подключение.

## Установка:
1. Подключиться к роутеру по SSH (к Entware)
2. Выполнить код:
	```
	curl -L -s "https://raw.githubusercontent.com/Ground-Zerro/HydraRoute/refs/heads/main/hydraroute.sh" > /opt/tmp/hydraroute.sh && chmod +x /opt/tmp/hydraroute.sh && /opt/tmp/hydraroute.sh
	```
3. Выбрать VPN из списка.

## Дополнительная информация:
**Как добавить домены в ipset**
1. Чтобы добавить домены для перенаправления, отредактируйте файл: `/opt/etc/AdGuardHome/ipset.conf`.
	```
	nano /opt/etc/AdGuardHome/ipset.conf
	```
 
   <details>
   <summary>Синтаксис файла ipset.conf (нажать, чтобы прочесть подробней)</summary>
   
	```
	intel.com,2ip.ru/bypass,bypass6
	instagram.com,cdninstagram.com/bypass,bypass6
	openai.com,chatgpt.com/bypass,bypass6
	```
   
	- В левой части через запятую указаны домены, требующие обхода.
	- Справа после слэша — ipset, в который AGH складывает результаты разрешения DNS-имён. В примере указаны создаваемые скриптом `ipset` для IPv4 и IPv6: `/bypass,bypass6`
	- Можно указать всё в одну строчку, можно разделить логически на несколько строк как в примере.
	- Домены третьего уровня и выше включаются сами, т.е. указание `intel.com` включает также `www.intel.com`, `download.intel.com` и прочее.
	- В примере добавлен «сигнальный» сервис [2ip.ru](https://2ip.ru/), для проверки работоспособности решения, показывающий IP-адрес туннеля (VPN), через которое вы перенаправите трафик.
   </details>

2. После добавления доменов необходимо перезапустить **AdGuard Home** командой:
	```
	/opt/etc/init.d/S99adguardhome restart
	```
	<details>
	<summary>P.S. Web панель для легкого редактирования ipset в разработке.</summary>
	
	![Image](https://github.com/user-attachments/assets/e75810c4-262f-4292-bba9-8cd450604453)
	</details>
<details>
<summary>Некоторые моменты работы скрипта</summary>

Скрипт устанавливает opkg пакеты adguardhome-go, ipset, iptables и ip-full, добавляет скрипты и настройки для их работы. Больше **ничего**.

- При установке каждого пакета проверяется результат т.к. в случае ошибки, например не хватило места, дальнейшее выполнение бессмысленно.
- Учтена особенность прошивок до 4.2.3 в которых при отключении системного DNS происходит выход из ssh сессии и выполнение скрипта прерывается.
- AdGuard Home:
	- Web админка и DNS-сервер биндятся только на IP роутера (br0), а не на (0.0.0.0).
	- Настроены DoT DNS и Bootstrap DNS-серверы.
</details>

## Планы на будущее
**to do**
- ~~Web панель в паблик релиз~~
- добавить дизайна
- авторизация в web панели (нужна вообще она?)
- написать wiki или FAQ

**Пожелания от пользоваталей**
- ~~[boosty](https://boosty.to/ground_zerro)~~
- опция: блокировать трафик если туннель не доступен (нет связи, отключен и т.п.)
- раздельная маршрутизация в два туннеля. Или в три?? ;)
- расширение списков ресурсов и black листов от сообществ
- опция: автоматическое обновление списокв по расписанию
- поддержка vless
- ~~[анигилятор](https://github.com/Ground-Zerro/HydraRoute/blob/main/uninstall.sh)~~
- Добавить кнопку чтобы можно было перебиндить IP AGH на 0.0.0.0 - на случай если используется несколько провайдеров или чуть более сложная архитектура домашней сети.
